#!/bin/sh
#
# Pre-commit hook to enforce code quality standards
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "Running pre-commit checks..."

# Check for trailing whitespace
echo "Checking for trailing whitespace..."
if git diff --cached --check --diff-filter=ACMR 2>&1 | grep -q "trailing whitespace"; then
    echo "${RED}Error: Trailing whitespace detected${NC}"
    echo "Auto-fixing trailing whitespace..."
    
    # Get list of staged files
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(go|md|yaml|yml|sh)$')
    
    if [ -n "$STAGED_FILES" ]; then
        for file in $STAGED_FILES; do
            if [ -f "$file" ]; then
                sed -i 's/[[:space:]]*$//' "$file"
                git add "$file"
            fi
        done
        echo "${GREEN}Trailing whitespace fixed and staged${NC}"
    fi
fi

# Run go fmt on staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.go$')
if [ -n "$STAGED_GO_FILES" ]; then
    echo "Running go fmt..."
    for file in $STAGED_GO_FILES; do
        if [ -f "$file" ]; then
            gofmt -w "$file"
            git add "$file"
        fi
    done
fi

# Run linter if available
if command -v golangci-lint >/dev/null 2>&1; then
    echo "Running golangci-lint..."
    if ! golangci-lint run ./...; then
        echo "${RED}Error: Linter found issues${NC}"
        echo "Fix the issues and try again"
        exit 1
    fi
else
    echo "${YELLOW}Warning: golangci-lint not found, skipping lint check${NC}"
fi

# Run tests (short mode for speed)
echo "Running tests..."
if ! go test -short ./...; then
    echo "${RED}Error: Tests failed${NC}"
    exit 1
fi

echo "${GREEN}All pre-commit checks passed!${NC}"
exit 0
