services:
  # Your application
  app:
    image: nginx:1.29-alpine
    container_name: app
    volumes:
      - secrets:/secrets:ro
    depends_on:
      secrets-sidecar:
        condition: service_healthy
    ports:
      - "8080:80"

  # Secrets sidecar
  secrets-sidecar:
    image: secrets-sync:latest
    container_name: secrets-sidecar
    volumes:
      - secrets:/secrets
      - ./config.yaml:/config.yaml:ro
      - ./.work:/work
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: dev-root-token
      CONFIG_FILE: /config.yaml
      LOG_LEVEL: info
      HTTP_PORT: 8081
    healthcheck:
      test: ["CMD", "/app/secrets-sync", "isready"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - "8081:8081"
    depends_on:
      - vault

  # Vault (for testing)
  vault:
    image: hashicorp/vault:1.21
    container_name: vault-sidecar
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: dev-root-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    command: server -dev -dev-root-token-id=dev-root-token
    ports:
      - "8202:8200"

volumes:
  secrets:
